{% load static %}
<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Edu Station - Sistema de Gestão Escolar</title>

    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Bootstrap Icons -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css">
    <!-- Custom CSS -->
    <link rel="stylesheet" href={% static "css/base.css" %}>
    {% block estilos %}
    <style>
        /*
        Correção de Z-Index para os Modais.
        
        O Bootstrap define o fundo (backdrop) com z-index: 1050
        e o modal com z-index: 1055.
        
        Algo no teu CSS está a quebrar esta ordem. Vamos forçar
        o modal a ter um z-index maior.
        */
        
        /* Força os teus modais a ficarem numa camada superior */
        #myModalDocente, #myModalAluno, #infoPopup, #cadSuccessfully {
            z-index: 1060 !important;
        }
    
        /* (Opcional, mas recomendado) 
        Garante que o modal de carregamento também funciona.
        */
        #carregamento{
            z-index: 1070 !important;
        }
    
        /* Garante que o backdrop fica na camada correta (abaixo dos modais).
        Isto é uma segurança extra.
        */
        .modal-backdrop {
            z-index: 1050 !important;
        }
    </style>
    {% endblock estilos %}
    
    <script>
        let isAuthenticated = {% if user.is_authenticated %}true{% else %}false{% endif %}
    </script>
</head>
<body class="bg-light d-flex flex-column" style="height: 100vh;">
    <!-- Navigation -->
    <nav class="navbar navbar-expand-lg navbar-dark bg-primary shadow-sm">
        <div class="container-fluid">
            <a class="navbar-brand fw-bold" href={% url "loginInicio:inicio" %}>
                <i class="bi bi-mortarboard-fill me-2"></i>Edu Station
            </a>
            
            {% if user.is_authenticated %}
            <div class="navbar-nav ms-auto">
                <div class="nav-item dropdown">
                    <a class="nav-link dropdown-toggle d-flex align-items-center" href="#" role="button" data-bs-toggle="dropdown">
                        <img src={% static "img/icone_perfil.jpg" %} alt="perfil" class="rounded-circle me-2" width="32" height="64">
                        <span class="d-none d-md-inline">{{ user.first_name|default:user.username }}</span>
                    </a>
                    <ul class="dropdown-menu dropdown-menu-end">
                        <li><a class="dropdown-item" href="{% url 'direcao:altDirecao' id=user.id %}">
                            <i class="bi bi-person-gear me-2"></i>Alterar Perfil
                        </a></li>
                        <li><hr class="dropdown-divider"></li>
                        <li><a class="dropdown-item text-danger" href="{% url 'loginInicio:logout_usuario' %}">
                            <i class="bi bi-box-arrow-right me-2"></i>Sair
                        </a></li>
                    </ul>
                </div>
            </div>
            {% endif %}
        </div>
    </nav>

    <!-- Main Content -->
    <main class="container-fluid flex-grow-1 d-flex flex-column" style="overflow-y: auto;">
        {% block main %}
        {% endblock main %}
    </main>

    {% block modal %}
    <!-- Loading Modal -->
    <div id="carregamento" class="modal fade" data-bs-backdrop="static" data-bs-keyboard="false" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-body text-center py-4">
                    <div class="spinner-border text-primary mb-3" role="status">
                        <span class="visually-hidden">Carregando...</span>
                    </div>
                    <p class="mb-0">Carregando...</p>
                </div>
            </div>
        </div>
    </div>
    {% endblock modal %}
    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    {% block javascript %}{% endblock javascript %}
    
    <script>
        // CPF formatting script
        document.addEventListener('input', (event) => {
            if (event.target && event.target.id === 'cpf_input') {
                let newValue = event.target.value.replace(/\s+/g, '');
                let arraySTR = newValue.split("");
                
                setTimeout(() => {
                    if (arraySTR.length === 3 && !newValue.includes(".")) {
                        arraySTR.splice(3,0,".");
                    } else if (arraySTR.length === 7 && newValue.includes(".")) {
                        arraySTR.splice(7,0,".");
                    } else if (arraySTR.length === 11 && !newValue.includes("-")) {
                        arraySTR.splice(11,0,"-");
                    }
                    newValue = arraySTR.join("");
                    event.target.value = newValue;
                }, 100);
            }
        });
    </script>
</body>
</html>